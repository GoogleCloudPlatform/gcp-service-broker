---
name: gcp-service-broker
icon_file: gcp_logo.png
label: Google Cloud Platform Service Broker
description: A service broker for Google Cloud Platform services
org: system

apply_open_security_group: true

migration: |
  properties['properties']['.properties.org']['value'] = 'system';
  if ('.properties.cloudsql_custom_plans' in properties['properties']){
      properties['properties']['.properties.cloudsql_mysql_custom_plans'] =
      {'value': properties['properties']['.properties.cloudsql_custom_plans']['value']};
  }

packages:
- name: gcp-service-broker
  type: app-broker
  manifest:
    buildpack: go_buildpack
    path: /tmp/gcp-service-broker.zip
    env:
      # You can override plans here.
  needs_cf_credentials: true
  enable_global_access_to_plans: true


# Uncomment this section if you want to display forms with configurable
# properties in Ops Manager. These properties will be passed to your
# applications as environment variables. You can also refer to them
# elsewhere in this template by using:
#     (( .properties.<property-name> ))
#
forms:
- name: root_service_account
  label: Root Service Account
  description: Please paste in the contents of the json keyfile (un-encoded) for your service account with owner credentials
  properties:
  - name: root_service_account_json
    label: Root Service Account JSON
    type: text
- name: database_properties
  label: Database Properties
  description: Connection details for the backing database for the service broker
  properties:
  - name: db_host
    type: string
    label: Database host
  - name: db_username
    type: string
    label: Database username
    optional: true
  - name: db_password
    type: secret
    label: Database password
    optional: true
  - name: db_port
    type: string
    default: '3306'
    label: Database port (defaults to 3306)
  - name: ca_cert
    type: text
    label: Server CA cert
    optional: true
  - name: client_cert
    type: text
    label: Client cert
    optional: true
  - name: client_key
    type: text
    label: Client key
    optional: true
- name: enable_disable
  label: Enable Services
  description: Enable or Disable Services
  properties:
    - name: gsb_service_google_bigquery_enabled
      label: Let end-users create plans for google_bigquery
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_bigtable_enabled
      label: Let end-users create plans for google_bigtable
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_cloudsql_mysql_enabled
      label: Let end-users create plans for google_cloudsql_mysql
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_cloudsql_postgres_enabled
      label: Let end-users create plans for google_cloudsql_postgres
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_datastore_enabled
      label: Let end-users create plans for google_datastore
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_ml_apis_enabled
      label: Let end-users create plans for google_ml_apis
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_pubsub_enabled
      label: Let end-users create plans for google_pubsub
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_spanner_enabled
      label: Let end-users create plans for google_spanner
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_stackdriver_debugger_enabled
      label: Let end-users create plans for google_stackdriver_debugger
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_stackdriver_trace_enabled
      label: Let end-users create plans for google_stackdriver_trace
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'
    - name: gsb_service_google_storage_enabled
      label: Let end-users create plans for google_storage
      type: dropdown_select
      configurable: true
      default: 'true'
      options:
        - name: 'true'
          label: 'Enable'
        - name: 'false'
          label: 'Disable'

service_plan_forms:
- name: cloudsql_mysql_custom_plans
  description: Generate custom plans for CloudSQL MySQL (required to enable the service for developers)
  label: CloudSQL MySQL Custom Plans
  optional: true
  properties:
    - name: display_name
      label: Display Name
      type: string
      description: "Display name"
      configurable: true
    - name: description
      label: Plan description
      type: string
      description: "Plan description"
      configurable: true
    - name: service
      label: Service
      type: dropdown_select
      description: "The service this plan is associated with"
      options:
        - name: '4bc59b9a-8520-409f-85da-1c7552315863'
          label: 'CloudSQL - MySQL'
    - name: tier
      label: Tier/Machine Type
      type: string
      description: "Case-sensitive tier/machine type name (see https://cloud.google.com/sql/pricing for more information)"
      configurable: true
    - name: pricing_plan
      label: Pricing Plan
      type: dropdown_select
      configurable: true
      default: PER_USE
      description: "Select a pricing plan (only for 1st generation instances)"
      options:
        - name: PER_USE
          label: 'Per-Use'
        - name: PACKAGE
          label: "Package"
    - name: max_disk_size
      label: Max Disk Size
      type: string
      default: '10'
      description: "Maximum disk size in GB (applicable only to Second Generation instances, 10 minimum/default)"
      configurable: true
- name: cloudsql_postgres_custom_plans
  description: Generate custom plans for CloudSQL PostgreSQL (required to enable the service for developers)
  label: CloudSQL PostgreSQL Custom Plans
  optional: true
  properties:
    - name: display_name
      label: Display Name
      type: string
      description: "Display name"
      configurable: true
    - name: description
      label: Plan description
      type: string
      description: "Plan description"
      configurable: true
    - name: service
      label: Service
      type: dropdown_select
      configurable: false
      description: "The service this plan is associated with"
      options:
        - name: 'cbad6d78-a73c-432d-b8ff-b219a17a803a'
          label: 'CloudSQL - PostgreSQL'
    - name: tier
      label: Tier/Machine Type
      type: string
      description: "a string of the form db-custom-[CPUS]-[MEMORY_MBS], where memory is at least 3840"
      configurable: true
    - name: pricing_plan
      label: Pricing Plan
      type: dropdown_select
      configurable: false
      description: "the pricing plan"
      options:
        - name: PER_USE
          label: 'Per-Use'
    - name: max_disk_size
      label: Max Disk Size
      type: string
      default: '10'
      description: "Maximum disk size in GB (10 minimum/default)"
      configurable: true
- name: bigtable_custom_plans
  description: Generate custom plans for Bigtable (required to enable the service for developers)
  label: Bigtable Custom Plans
  optional: true
  properties:
    - name: display_name
      label: Display Name
      type: string
      description: "Display name"
      configurable: true
    - name: description
      label: Plan description
      type: string
      description: "Plan description"
      configurable: true
    - name: service
      label: Service
      type: dropdown_select
      description: "The service this plan is associated with"
      options:
        - name: 'b8e19880-ac58-42ef-b033-f7cd9c94d1fe'
          label: 'Bigtable'
    - name: storage_type
      label: Storage Type
      type: string
      description: "Either HDD or SSD (see https://cloud.google.com/bigtable/pricing for more information)"
      configurable: true
      default: 'SSD'
    - name: num_nodes
      label: Number of Nodes
      type: string
      description: "Between 3 and 30 (see https://cloud.google.com/bigtable/pricing for more information)"
      configurable: true
      default: '3'
- name: spanner_custom_plans
  description: Generate custom plans for Spanner (required to enable the service for developers)
  label: Spanner Custom Plans
  optional: true
  properties:
    - name: display_name
      label: Display Name
      type: string
      description: "Display name"
      configurable: true
    - name: description
      label: Plan description
      type: string
      description: "Plan description"
      configurable: true
    - name: service
      label: Service
      type: dropdown_select
      description: "The service this plan is associated with"
      options:
        - name: '51b3e27e-d323-49ce-8c5f-1211e6409e82'
          label: 'Spanner'
    - name: num_nodes
      label: Number of Nodes
      type: string
      description: "A minimum of 3 nodes is recommended for production environments. (see https://cloud.google.com/spanner/pricing for more information)"
      configurable: true
      default: '1'
